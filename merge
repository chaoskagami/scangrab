#!/bin/bash

MINIFY=1

TARGET="$1"
if [ "$TARGET" = "" ]; then
	TARGET="./scangrab.min"
elif [ "$TARGET" = "-h" ]; then
	echo "This script merges the modules and the core to make"
	echo "a standalone script. By default, the output is"
	echo "	./scangrab-merge"
	echo "but you can also pass where you would like as the"
	echo "first parameter, like so:"
	echo "	./merge /usr/local/bin/scangrab"
	echo "This script DOES check to see if you passed it a"
	echo "folder, and will refuse to work."
	echo "It also optimizes the output for size; e.g. minify."
	echo "If you don't want minified output, open this script"
	echo "and change MINIFY=1 to MINIFY=0 at the top."
	echo "Scangrab will experimentally work with zsh;"
	echo "change the shebang if you feel like it."
	exit 0
fi

if [ -d "$1" ]; then
	echo "Was told to overwrite a folder. Cowardly refusing."
	exit 1
fi

# Spit support first.
cat support > $TARGET.tmp

# Module code.
MODS=(`ls modules/`)

# Module list.
echo "MODS=(${MODS[@]})" >> $TARGET.tmp

# Module content
for module in ${MODS[@]}; do
	cat modules/$module >> $TARGET.tmp
done

# Actual code.
cat core >> $TARGET.tmp

if [ $MINIFY = 1 ]; then
	# Remove leading and trailing WS.
	sed -i "s/^[[:space:]]*//" $TARGET.tmp
	sed -i "s/[[:space:]]*$//" $TARGET.tmp

	# Remove lines consisting of a comment.
	sed -i "/^[[:space:]]*#.*/d" $TARGET.tmp

	# Remove lines consisting of WS.
	sed -i "/^[[:space:]]*$/d" $TARGET.tmp

	# Replace all instances of "echo" and "echo -e" with 'o'.

	# First define the replacements.
	echo -e "o() {\necho \"\$@\"\n}" >> $TARGET.fun
	echo -e "n() {\necho -ne \"\$@\"\n}" >> $TARGET.fun
	echo -e "e() {\necho -e \"\$@\"\n}" >> $TARGET.fun

	# Now repl.
	sed -i "s/^echo -e/e/g" $TARGET.tmp
	sed -i "s/^echo -ne/n/g" $TARGET.tmp
	sed -i "s/^echo -en/n/g" $TARGET.tmp
	sed -i "s/^echo/o/g" $TARGET.tmp


	# We just nuked the shebang, so fix that.
	echo "#!/bin/bash"|cat - $TARGET.fun $TARGET.tmp >> $TARGET.min && mv $TARGET.min $TARGET

	# Some function names and etc can be simplified.
	sed -i "s/auto_/a_/g" $TARGET
	sed -i "s/scrape_/s_/g" $TARGET
	sed -i "s/dl_/d_/g" $TARGET
	sed -i "s/_url/_u/g" $TARGET
	sed -i "s/_longname/_l/g" $TARGET
	sed -i "s/_SPINNER_CHAR/_SC/g" $TARGET
	sed -i "s/spinner/ss/g" $TARGET
	sed -i "s/done_spin/se/g" $TARGET

	# Remove tmp.
	rm $TARGET.{fun,tmp}
fi

# Life needs to be easier.
chmod +x $TARGET
